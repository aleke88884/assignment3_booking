<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ресурсы - SmartBooking</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo">SmartBooking</div>
            <div class="nav-links">
                <a href="index.html">Главная</a>
                <a href="resources.html" class="active">Ресурсы</a>
                <a href="bookings.html" id="bookings-link" style="display:none;">Мои брони</a>
                <a href="auth.html" id="auth-link">Войти</a>
                <a href="#" id="profile-link" style="display:none;"><span id="user-name"></span></a>
                <a href="#" id="logout-link" style="display:none;">Выйти</a>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 80px;">
        <h1>Доступные ресурсы</h1>
        
        <div class="filters">
            <input type="text" id="search" placeholder="Поиск..." onkeyup="filterResources()">
            <select id="category-filter" onchange="filterResources()">
                <option value="">Все категории</option>
            </select>
            <select id="city-filter" onchange="filterResources()">
                <option value="">Все города</option>
            </select>
        </div>

        <div id="resources-grid" class="resources-grid"></div>
    </div>

    <!-- Модальное окно для бронирования -->
    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBookingModal()">&times;</span>
            <h2 id="modal-resource-name"></h2>
            <div id="modal-resource-photos"></div>
            <div id="modal-resource-details"></div>

            <form id="booking-form">
                <div class="form-group">
                    <label>Дата и время начала</label>
                    <input type="datetime-local" id="start-time" required>
                </div>
                <div class="form-group">
                    <label>Дата и время окончания</label>
                    <input type="datetime-local" id="end-time" required>
                </div>
                <div class="form-group">
                    <label>Комментарий</label>
                    <textarea id="notes" rows="3" placeholder="Дополнительные пожелания..."></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block">Забронировать</button>
                </div>
                <div id="booking-error" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Модальное окно для фотогалереи -->
    <div id="photo-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closePhotoModal()">&times;</span>
            <img id="photo-modal-img" src="" style="width: 100%; border-radius: 8px;">
            <div id="photo-thumbnails" style="display: flex; gap: 10px; margin-top: 15px; overflow-x: auto;"></div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        let currentResource = null;
        let allResources = [];

        // Загрузка ресурсов
        loadResources();
        loadCategoryFilter();

        function loadCategoryFilter() {
            fetch(`${API_URL}/resources`)
                .then(r => r.json())
                .then(resources => {
                    const cities = [...new Set(resources.map(r => r.city).filter(c => c))];
                    const cityFilter = document.getElementById('city-filter');
                    cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        cityFilter.appendChild(option);
                    });
                });
        }

        function filterResources() {
            const search = document.getElementById('search').value.toLowerCase();
            const category = document.getElementById('category-filter').value;
            const city = document.getElementById('city-filter').value;

            const filtered = allResources.filter(r => {
                const matchSearch = r.name.toLowerCase().includes(search) || 
                                  (r.description && r.description.toLowerCase().includes(search));
                const matchCategory = !category || r.category_id == category;
                const matchCity = !city || r.city === city;
                return matchSearch && matchCategory && matchCity;
            });

            displayResources(filtered);
        }

        function openBookingModal(resourceId) {
            if (!isLoggedIn()) {
                alert('Пожалуйста, войдите в систему для бронирования');
                window.location.href = 'auth.html';
                return;
            }

            currentResource = allResources.find(r => r.id === resourceId);
            if (!currentResource) return;

            document.getElementById('modal-resource-name').textContent = currentResource.name;

            const photosHtml = currentResource.photos && currentResource.photos.length > 0
                ? `<div style="display: flex; gap: 10px; overflow-x: auto; margin-bottom: 15px;">
                    ${currentResource.photos.map(photo => `
                        <img src="${photo.url}" onclick="openPhotoModal(${currentResource.id}, '${photo.url}')"
                             style="width: 150px; height: 100px; object-fit: cover; cursor: pointer; border-radius: 4px;">
                    `).join('')}
                   </div>`
                : '';

            document.getElementById('modal-resource-photos').innerHTML = photosHtml;
            document.getElementById('modal-resource-details').innerHTML = `
                <p><strong>Цена:</strong> ${currentResource.price_per_hour || 'Не указана'} ₸/час</p>
                <p><strong>Вместимость:</strong> ${currentResource.capacity} чел.</p>
                <p>${currentResource.description || ''}</p>
            `;

            document.getElementById('booking-modal').style.display = 'block';
        }

        function closeBookingModal() {
            document.getElementById('booking-modal').style.display = 'none';
            document.getElementById('booking-form').reset();
            document.getElementById('booking-error').textContent = '';
        }

        function openPhotoModal(resourceId, mainPhotoUrl) {
            const resource = allResources.find(r => r.id === resourceId);
            if (!resource || !resource.photos) return;

            document.getElementById('photo-modal-img').src = mainPhotoUrl;

            const thumbnails = resource.photos.map(photo => `
                <img src="${photo.url}" onclick="document.getElementById('photo-modal-img').src='${photo.url}'"
                     style="width: 80px; height: 60px; object-fit: cover; cursor: pointer; border: 2px solid ${photo.url === mainPhotoUrl ? '#007bff' : '#ddd'}; border-radius: 4px;">
            `).join('');

            document.getElementById('photo-thumbnails').innerHTML = thumbnails;
            document.getElementById('photo-modal').style.display = 'block';
        }

        function closePhotoModal() {
            document.getElementById('photo-modal').style.display = 'none';
        }

        document.getElementById('booking-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await createBooking();
        });

        window.onclick = function(event) {
            const bookingModal = document.getElementById('booking-modal');
            const photoModal = document.getElementById('photo-modal');
            if (event.target == bookingModal) {
                closeBookingModal();
            }
            if (event.target == photoModal) {
                closePhotoModal();
            }
        }
    </script>
</body>
</html>
